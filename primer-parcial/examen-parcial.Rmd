---
title: "Examen parcial - Otoño 2020"
author: Yalidt Díaz y
Bruno Gonzalez
output: html_document
---

**Entrega:** Enviar la carpeta que incluya datos y codigo de solución a mas
tardar el 19 de octubre antes de las 12:00pm (mediodia), por correo electrónico
con el título fundamentos-parcial, un solo documento por equipo. No se aceptarán
entregas extemporáneas. Será mejor entregar un examen resuelto parcialmente, que
no entregar nada.

**Instrucciones:**
  
* Tus respuestas deben ser claras y debes explicar los resultados, incluye
también tus procedimientos/código de manera ordenada, y el código comentado.

* Se evaluará la presentación de resultados (calidad de las gráficas, tablas,
...), revisa la sección de visualización en las notas.

* Las sesiones del Martes 13 y Jueves 15 a las 10 am, serán espacios para
resolver dudas que puedan surgir del exámen.

* No pueden compartir soluciones entre diferentes equipos, o alumnos del grupo
001 de esta misma materia.

* Al entregar este examen afirmas que el trabajo se realizó sólo con tu
compañero de equipo. El material que utilizaste para apoyarte consistió de las
notas en clase (pdf en canvas), el codigo fuente de las notas en el repositorio
de Github, y el video disponible de la sesión de Martes 6 de Octubre. 

* Al entregar estás dando tu consentimiento para que bajo sospecha y suficiente
evidencia de copia se anule tu evaluación.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error = TRUE)
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(patchwork)
library(nullabor)
library(rsample)
library(knitr)
```


# Análisis exporatorio (25 \%)

### 1. NBER TH 

Considera la tabla de datos dada en tabla_nber_th.csv. Es la tabla de
frecuencias de 4353 pilotos de la segunda guerra mundial, donde los individuos
están clasificados según:
  
* Tipo de ocupación en 1969. SE significa self-employed.  
* Resultados de estudios de aptitud de 1943 (A5 es el nivel más alto, y A1 el
más bajo).
* Nivel de educación en 1969 (esta incluye años de escuela en 1943 más estudios
posteriores a la guerra). E4 es el nivel más alto y E1 es el nivel más bajo.

1. ¿Qué relación existe entre aptitud (1943) y el nivel de educación (1969)?
Describe esta relación usando tablas de porcentajes y de índices (o perfiles).

```{r}
pilotos<- read.csv("./datos/tabla_nber_th.csv")
glimpse(pilotos)
```

```{r 1.1 Tabla porcentajes}

tabla_cruzada <- pilotos %>% 
  group_by(Education, Aptitude) %>% 
  summarise(Freq = sum(Freq)) %>% 
  ungroup() %>% 
  group_by(Education) %>%
  mutate(prop = round(100*Freq/sum(Freq),2)/100) %>% 
  select(-Freq) %>%
  pivot_wider(names_from = Education, values_from = prop)

tabla_cruzada 
```

```{r 1.2 Tabla perfiles}
num_grups <- n_distinct(pilotos %>% select(Education))

tabla <-  pilotos %>% 
  group_by(Education, Aptitude) %>% 
  summarise(Freq = sum(Freq)) %>% 
  ungroup() %>% 
  group_by(Education) %>% 
  mutate(prop_aptitud = 100*Freq/sum(Freq)) %>% 
  group_by(Aptitude) %>% 
  mutate(prop_educacion = sum(prop_aptitud)/num_grups) %>% 
  mutate(perfil = 100 * (prop_aptitud/prop_educacion-1))

tabla_perfil <- tabla %>% 
  select(Education, Aptitude, perfil, pct=prop_educacion) %>% 
  pivot_wider(names_from=Education, values_from=perfil, values_fill=list(perfil=-100))

tabla_perfil
```
**R. **



2. Describe la relación entre nivel de educación y ocupación ¿Qué concluyes de esta relación? ¿Cuáles dirías que son ocupaciones asociadas a educación alta y cuáles a educación baja?

```{r}
```

# Mini-proyecto (75 \% + 5\%)

Utilizaremos los datos de un experimento de modificación del
tiempo *(weather)* en el cual se investigó el efecto de yoduro de plata (IAg)
para atenuar tormentas eléctricas [Baughman et al
1976](https://www.jstor.org/stable/26177578?seq=1#metadata_info_tab_contents)

Los datos se generaron seleccionando al azar tormentas candidato en donde se
incorporó el aerosol *(seeding)* de manera aleatoria. Es decir, una vez
seleccionando una posible tormenta, se decidió al azar si rociar o no las nubes
con el aerosol mencionado.

Los resultados se pueden cargar de la siguiente tabla. Las columnas son la fecha
en la que ocurrió la tormenta, el número de truenos que hicieron contacto con
tierra, y el indicador si la tormenta fue tratada con aerosoles o no. Previo a la 
recolección de datos se espera que el yoduro de plata disminuya el número de 
truenos que impacten la tierra.

```{r}
#Lectura de los datos
truenos <- read_csv('datos/tormentas.csv')
truenos
```

## Análisis exploratorio y pruebas de hipótesis 

1. Ahora haremos un breve EDA para determinar ciertos supuestos para aplicar las
técnicas que hemos visto en clase. Haz resumenes númericos del número de truenos 
reportados. 


```{r 2.1 Resumen numérico}
truenos$conteos %>% summary()
```

```{r 2.2 EDA básico}

#Librerias
library(ggplot2)
library(gridExtra)

g1 <- ggplot(truenos, aes(conteos)) + 
  geom_histogram(bins = 35) + ggtitle("Distribución del número de truenos")

g2 <- ggplot(truenos, aes(conteos)) +
  geom_boxplot() + ggtitle("Boxplot del número de truenos")

grid.arrange(g1, g2) 
```

2. Qué observaciones puedes hacer de este breve resumen? (Considera que la
variable de interés son los conteos de truenos)

**R. Lo primero que salta de este análisis es que hay datos bastante atípicos de 358(justamente es el valor máximo 
que toma esta variable), lo cual nos hace pensar si esta información fue capturada correctamente o si realmente se obtuvo ese valor en esa tormenta electrica. Aunado a esto, dado que esos outliers son muy elevados altera la media 
de los datos por su ponderación.

Por otra parte, en cuanto a la distribución se observa un hueco entre el valor de aproximadamente 80 y 85, sin mencionar que la distribución esta claramente sesgada a la derecha. De igual manera, entre los valores de 50 hay una caída que se mantiene constante en el número de truenos  hasta aproximadamente el número 70, lo cual nos hace pensar sobre posibles asignaciones de este valor secuenciales uniformes en ese rango.

Por último en el diagrama de caja y brazos, sin tomar en cuenta los datos atípicos, se podría decir
que los datos son casi simétricos respecto a la media, aunque el brazo esta más alargado del lado derecho.**

3. Ahora trataremos de validar un supuesto clásico, el supuesto de normalidad.
Auxiliate de herramientas gráficas para explorar este supuesto y determinar si
es razonable para nuestro conjunto de datos.


```{r 2.3 Grafica de Cauntiles}

qqnorm(truenos$conteos, main="Gráfica de cuantiles del numero de truenos", xlab="",
         ylab="")
qqline(truenos$conteos, col=2)

```

**R. De acuerdo con el apoyo visual de las gráficas concluiríamos que no sería razonable utilizar un supuesto de normalidad, principalmente por el problema de los datos aberrantes que tenemos y porque en el centro la gráfica de cuantiles los puntos no se apegan mucho a la línea recta. De igual manera, el histograma parece tener una forma guassiana, pero tiene un comportamiento extraño entre los valores 50 y 70 de esta variable.

Probablemente si utilizaramos alguna otra herramienta numérica que nos ayude a determinar si se distribuye 
normalmente se podría cambiar de opinión dependiendo que tan conservadores seamos **

Posiblemente estén tentados a descartar los valores atípicos. Claramente tenemos
un problema. Si quisiéramos hacer una prueba de hipótesis por medio de
diferencias en media, dicho valor atípico sesgaría nuestra distribución de
referencia. Y el efecto sería catastrófico, valores grandes de nuestro estimador
de prueba se verían como datos usuales bajo la distribución de referencias.

Una alternativa para estos casos, que no vimos en clase, es hacer un prueba de
diferencia en suma de órdenes *(sum of ranks).* Para esto ordenamos los datos
por la variable `conteos` y asignamos una variable `orden` que asigna el lugar
que dicho registro recibe.

```{r}

truenos <- truenos %>% 
  arrange(conteos) %>% 
  mutate(orden = min_rank(conteos))

truenos
```

La idea es sencilla, si un grupo tiende a tener menores observaciones *la suma
de sus órdenes* será menor que la suma de los órdenes del otro grupo. La
diferencia de la suma de órdenes será nuestro estadístico de prueba. Y podremos
comparar el observado con respecto a la distribución de referencia.

4. Escribe el código adecuado para nuestro estadístico de prueba: la diferencia
de la suma de órdenes.

```{r 2.3 Diferencia observada}

diferencia_observada <- truenos %>% group_by(aerosol) %>%
  summarise(suma_ordenes= sum(orden), .groups = 'drop') %>%
  spread(key=aerosol, value = suma_ordenes) %>%
  mutate(dif= No-Si) %>% pull(dif)

diferencia_observada
```

**R. Esta primera diferencia observada nos estaría indicando que las tormetas sometidas al aerosol tienen un menor número de truenos**

5. La distribución de referencia implica todas las asignaciones al azar de la 
etiqueta que marca si la tormenta fue modificada artificialmente con aerosol. 
¿Cuántas posibilidades existen para dicha distribución?

```{r 2.4 Función de permutaciones}
permutacion = function(n, x) {
  
### Función que calcula el total de permutaciones de un conjunto de datos
# Inputs:
# n : escalar, Numero de de renglones en el dataset (en este caso órdenes)
# x : escalar, Valores posible de la variable que se desea escoger
# Outputs:
# permutacion : escalar, que indica el número de permutaciones posibles
  
  factorial(n) / factorial(n-x) / factorial(x)
}
permutacion(23,2)
```

**R. El total de posibilidades que se podrían obtener serían 253, porque hay 23 órdenes y 2 posibles valores (Si o No)**

6. Por suerte, ya no estamos en los 70's y podemos auxiliarnos de simulación para
construir la distribución de permutaciones. Genera las permutaciones correspondientes
por medio de simulación. Alrededor de $10^4$ serán mas que suficientes. 

```{r 2.5 Permutaciones, cache = T }

#Cálculo de las simulaciones
set.seed(4020) 
permutaciones <- lineup(null_permute("aerosol"), 
                        truenos, n = 10000)
```

7. Calcula el estadístico de prueba para las permutaciones y grafica un histograma donde muestres el estadistico de prueba observado. 

```{r 2.6 Diferencia en distribución de referencia (con permutaciones)}

#Cálculo de la diferencias en la simulación
distribucion_ref <- permutaciones %>% group_by(.sample,aerosol) %>%
  summarise(suma_ordenes=sum(orden), .groups = 'drop') %>%
  pivot_wider(names_from = aerosol, values_from = suma_ordenes) %>%
  mutate(dif=(No-Si)) 

```


```{r 2.7 Histograma de referencia con estadistico observado}

ggplot(distribucion_ref, aes(x = dif)) +
  geom_histogram(binwidth = 9.5) + xlab("") + labs(subtitle = " ") +
    geom_vline(xintercept = diferencia_observada, colour = "red") +
  annotate("text", x = diferencia_observada, y = -15 , label = "diferencia observada", colour = "blue") +
  ggtitle("Distribución nula o de referencia ")

```

8. Calcula el *valor-p* de la hipótesis nula y escribe tu reporte sobre dicha prueba de hipótesis. 

```{r 2.8 Valor-p de la prueba de hipótesis}

dist_perm <- ecdf(distribucion_ref$dif)
#Nuestra prueba de hipótesis es de 2 colas porque H_0 : no hay diferencias y H_1 : si hay diferencia 
2 * min(dist_perm(diferencia_observada), (1 - dist_perm(diferencia_observada)))

```

**R. Nuestra Hipótesis Nula H_0 era que no había diferencias entre las tormentas que tuvieron el aerosol y las que no (prueba de 2 colas):


$$ H_0 : \sum({ordenes_{S}}-{ordenes_{N}})=0$$
$$ H_1 : \sum({ordenes_{S}}-{ordenes_{N}}) \neq 0$$

Dado que el valor-p obtenido fue de .0214, si tomaramos un $\alpha = .05$ nuestro valor es aún mas pequeño que este $\alpha$, con lo cual estaríamos rechazando $H_0$ y nos quedaríamos con $H_1$. Es decir existe evidencia de que hay diferencia entre los grupos de órdenes de tormentas cuando se pone el aerosol **


```{r}
aux <- distribucion_ref %>% gather(aerosol_sim , ordenes_sim, No:Si)

g1 <- ggplot(aux, aes(x = aerosol_sim, y = ordenes_sim)) + 
  geom_boxplot(outlier.size = 1, outlier.colour = "red", outlier.shape = 21) + 
  coord_flip()

g2 <- ggplot(truenos, aes(x = aerosol, y = orden)) + 
  geom_boxplot(outlier.size = 1, outlier.colour = "red", outlier.shape = 21) +
  coord_flip()

grid.arrange(g1, g2) 
```
**R. Realizamos 2 gráficas de caja y brazos para ver como se comportaban los datos originales y los simulados, en ambos casos el número de ordenes se ve que cambia dependiendo si se aplica o no el aerosol, lo único curioso es que en las simulaciones resultó que las tormentas que no reciben el aerosol son las que tienen menor rank, sinembargo claramente se observa que hay diferencia entre los grupos**

**5\% extra.** A continuación mostramos lo que una prueba vista en cursos clásicos de estadística arrojaría. ¿Puedes interpretarla?

```{r 2.9 Wilcox Test, warning = FALSE}

wilcox.test(truenos$conteos~truenos$aerosol, 
            alternative="greater") 
```

**R. Esta prueba justamente calcula el valor-p y resuelve la prueba de hipótesis sobre las órdenes que son el número de rank que tiene cada tormeta dependiendo del número de truenos que recibió. Nos indica un valor-p de .0156 porque esta considerando una prueba de hipótesis de 1 sola cola (justo por eso en el parámetro de la función de indica : alternative = "greater"), y este valor p es pequeño (de .0156), con lo cual al final nos indica la $H_1 > 0$ (la hipótesis alternativa es mayor a cero). De esta manera indica que la diferencia entre la suma de los rank(órdenes) es mayor a 0, por lo que si hay evidencia en contra de $H_0$.**

# Distribución *bootstrap* para estimadores con cocientes

Supongamos ahora que para efectos del análisis la dispersión de los datos de las
tormentas se pueden caracterizar por medio de la estadística de escala en L
*(L-scale)* [Hoskin,
1990](https://www.jstor.org/stable/2345653?seq=1#metadata_info_tab_contents),
$$ \lambda_2 = \frac{2}{n (n -1)} \sum_{i = 1}^{n-1} \sum_{j = i + 1}^n |x_i - x_j|,$$
donde $\lambda_2$ caracteriza la mitad de la distancia promedio entre todos los
posibles pares en una muestra de tamaño $n.$ Para un conjunto de datos muy
concentrado el valor de $\lambda_2$ será muy pequeño, mientras que para un
conjunto de datos mas dispersos éste será grande.

Compararemos el valor de $\lambda_2$ para las tormentas tratadas con aerosoles y
las tormentas sin el tratamiento. Para esto compararemos el cociente 
$$\theta_L = \frac{\lambda_2^{S}}{\lambda_2^{N}},$$
donde $\lambda_2^{S}$ denota la estadística $L$ calculada para las tormentas con
aerosol, y $\lambda_2^{N}$ para las tormentas sin aerosol.

Si siguiéramos el camino de prueba de hipótesis consideraríamos una hipótesis nula donde
$\theta_L = 1$.

9. Escribe la función que calcule la estadística $\lambda_2$. Para esto
sugerimos le heches un ojo a la función `dist`. Una vez que tengas esa función
utilizala para realizar simulaciones como en los puntos anteriores y puedas
explorar la distribución de referencia. Qué observas de la distribución
resultante?

**R. **

```{r 3.1 Lambda Function}
lambda <- function(df){
  data <- df %>% filter(aerosol == "Si") %>% select(conteos)
  x <- as.matrix(data[1])
  n <- length(x)
  dist <- NULL
  for(i in 1:(n-1)){
    for(j in (i+1):n){
      X_i <- x[i]
      X_j <- x[j]
      diferencia <- abs(X_i-X_j)
    }
    dist = append(dist,diferencia)
  }
  return(dist)
}

prueba <- head(truenos,5)
lambda(prueba)
##AYUDA X_j se queda fijo, debería dar 2,5,1



# data <- prueba %>% filter(aerosol == "Si") %>% select(conteos)
# x <- as.matrix(data[1])
# n <- length(x)
# i <- 1
# for(i in 1:n){
#   for(j in (i+1):(n)){
#     dist <- NULL
#     X_i <- x[i]
#     X_j <- x[j]
#     diferencia <- abs(X_i-X_j)
#     dist = append(dist,diferencia)
#   }
# }
```

10. Cuál es tu conjetura de que la distribución de referencia tenga esa forma?

**R. **

En este caso hacer una prueba de hipótesis para la estadística de la
$L-$dispersión por medio de permutaciones no es la mejor estrategia. Esto es por
que la hipótesis nula alberga el supuesto de que **todos** los aspectos de la
distribución de truenos que golpean la tierra son los mismos tanto para las
tormentas modificadas por aerosoles y las que no lo son. En este caso,
quisiéramos ser mas laxos y permitir algunas propiedades diferentes entre las
dos distribuciones.

Usaremos el método de *bootstrap* para calcular la distribución de remuestreo 
de nuestra estadística observada. Como sabemos, el método de bootstrap nos informa
de la dispersión de nuestra estadística de interés, que en este caso es la $L-$dispersión. 

11. Escribe el código necesario para implementar un bootstrap no paramétrico.
Recuerda que el remuestreo debe de respetar el proceso generador de datos.
*Pista:* Sugerimos utilizar la libreria de `rsample`, considera que tu función
de estimación debe de regresar una tabla, `tibble`, con dos columnas `estimate`
y `term`, donde se registra el valor estimado y nombre de tu estadistica. Por
supuesto puedes utilizar otras funciones.

**R. **

```{r}

```

12. Reporta la dispersión de tu estimador en forma de intervalos con el método 
más adecuado de los vistos en clase. 

**R. **

```{r}

```


13. Dado el estimador y los intervalos calculados arriba, escribe un breve resumen. 

**R. **
